<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>BLOCKCAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <!-- css -->
    <link href="stylesheets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="stylesheets/css/fancybox/jquery.fancybox.css" rel="stylesheet">
    <link href="stylesheets/css/jcarousel.css" rel="stylesheet" />
    <link href="stylesheets/css/flexslider.css" rel="stylesheet" />
    <link href="stylesheets/css/style.css" rel="stylesheet" />

    <!-- Theme skin -->
    <link href="stylesheets/skins/default.css" rel="stylesheet" />
    <style>
        #selllist {
  counter-reset: section;
}
        #buylist {
  counter-reset: section;
}

.count:before {
  counter-increment: section;
  content: counter(section);
}
    </style>


</head>


<body>
    <div id="wrapper">
        <!-- start header -->
        <header>
            <div class="navbar navbar-default navbar-static-top">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/"><span>B</span>lockcar</a>
                    </div>


                    <div class="navbar-collapse collapse ">
                        <table align="right">
                            <tr>
                                <td height="20"> </td>
                                <td> </td>
                            </tr>
                            <tr>
                                <td width="100"><a href="#"><span class="fa fa-address-card-o"></span> 계정 주소 : </a></td>
                                <td width="330"><span id="contractAddress">
                                        <%= contractaddr %></span></td>
                                <td width="200" align="right"><a href="#"><span class="fa fa-gg-circle"></span> 보유 토큰 : </a>&nbsp;&nbsp;&nbsp;<span id="TCTNum"></span></td>
                                <td width="50"><a href="#">&nbsp;TCT</a></td>

                            </tr>
                        </table>
                    </div>



                    <form action='/mypage' method="POST" name='addrForm'>
                        <input type="hidden" id="accountaddr" name="accountaddr" value="">
                    </form>

                    <form action='/beforesellcar' method="POST" name='addrForm1'>
                        <input type="hidden" id="accountaddr" name="accountaddr" value="">
                    </form>


                    <div class="navbar-collapse collapse ">
                        <ul class="nav navbar-nav">
                            <li><a href="/">Home</a></li>
                            <li><a href="/enrollcar">차대번호 등록</a></li>
                            <li><a href="/buycar">차량 구입</a></li>
                            <li><a href="#" onclick="javascript:document.addrForm1.submit();">차량 판매</a></li>
                            <li><a href="/repair">수리이력 등록</a></li>
                            <li><a href="/searchRepairInfo">수리이력 조회</a></li>
                            <li class="active"><a href="#" onclick="javascript:document.addrForm.submit();">나의 정보</a></li>



                        </ul>
                    </div>

                </div>
            </div>
           
        </header>
        <!-- end header -->
        <section id="inner-headline">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <ul class="breadcrumb">
                            <li><a href="#"><i class="fa fa-home"></i></a><i class="icon-angle-right"></i></li>
                            <li class="active">MY PAGE</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <section id="content">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4">
                        <aside class="right-sidebar">

                            <div class="widget">
                                <h5 class="widgetheading">MENU</h5>
                                <ul class="cat">
                                    <li class="active"><i class="icon-angle-right"></i><a href="#tab1" data-toggle="tab"><span id="token_value"></span>나의 TCT</a><span> </span></li>
                                    <li><i class="icon-angle-right"></i><a href="#tab2" data-toggle="tab">나의 판매내역</a><span></span></li>
                                    <li><i class="icon-angle-right"></i><a href="#tab3" data-toggle="tab">나의 구매내역</a><span></span></li>

                                </ul>
                            </div>


                        </aside>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="tab1">
                            <div class="col-lg-12">

                                <center>
                                    <div>
                                        <h3>현재 나의 TCT</h3>
                                    </div>
                                </center><br>
                                <center>
                                    <h1> <span id="TCTNum2"></span> TCT </h1>
        
                                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#ModalCenter">
                                        거래가능액 설정
                                    </button>

                                    <!-- Modal -->
                                    <div class="modal fade" id="ModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLongTitle">출금가능액 설정</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>TCT가 거래에 쓰일 수 있도록 TCT 출금가능 갯수를 입력해주세요.</h5>
                                                    <div class="col-lg-6 col-lg-offset-3">
                                                        <form class="form-search">
                                                            <input class="form-control" id="Coin_Approve" type="text" placeholder="1000">
                                                        </form>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" onclick="approve(); return false;" class="btn btn-theme">설정</button>
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>

                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    <button type="button" class="btn btn-theme" data-toggle="modal" data-target="#ModalWithdraw">
                                        토큰 이체
                                    </button>

                                    <div class="modal fade" id="ModalWithdraw" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLongTitle">토큰 출금</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>입금할 계좌 주소와 송금을 원하는 TCT 개수를 입력해주세요</h5>
                                                    <h6>Enter Address for withdraw And Number</h6>
                                                    <div class="col-lg-6 col-lg-offset-3">
                                                        <form class="form-search">
                                                            주소<input class="form-control" type="text" placeholder="0x....." id="withdraw_Address">
                                                            개수<input class="form-control" type="text" placeholder="1000" id="withdraw_value">
                                                        </form>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" onclick="transfer();return false;" class="btn btn-theme">설정</button>
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>

                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                </center><br>


                            </div>
                        </div>
                        <div class="tab-pane fade in" id="tab2">
                            <div class="col-lg-12">
                                <article>
                                    <div class="post-image">
                                        <div class="post-heading">
                                            <h3>회원님께서 판매하는 차량입니다.</h3>
                                        </div>
                                        <hr>
                                        <table class="table table-bordered table-hover slideanim" id="selllist">
                                            <thead>
                                                <tr>
                                                    <th text-align="center" class="text-center">번호</th>
                                                    <th text-align="center" class="text-center">거래번호</th>
                                                    <th text-align="center" class="text-center">차대번호</th>
                                                    <th text-align="center" class="text-center">차량 판매가격 변경</th>
                                                    <th text-align="center" class="text-center">거래상태</th>
                                                    <th text-align="center" class="text-center">상세보기</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% sell.forEach(function(item, index){  %>

                                                <tr>
                                                    <td class="count text-center"></td>
                                                    <td class="text-center">
                                                        <%= item.dealnumber %>
                                                    </td>
                                                    <td class="text-center">
                                                        <%= item.wholenumber %>
                                                    </td>
                                                    <td class="text-center"><button type="button" class="btn btn-warning" data-toggle="modal" data-target="#selldetail_<%= index %>">
                                                            변경
                                                        </button>

                                                        <!-- Modal -->
                                                        <div class="modal fade" id="selldetail_<%= index %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                                            <div class="modal-dialog modal-dialog-centered" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h3 class="modal-title">차량 판매가격 변경</h3>
                                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body">

                                                                        <h5>판매차량의 변경할 가격을 TCT 단위로 입력해주세요.</h5>

                                                                        <form action="/mypage/changeprice" method="post" class="form-search">
                                                                            <cetner>
                                                                                <input type="text" class="form-control text-center" name="price" style="width:50%;display:inline;">&nbsp;&nbsp;<button type="submit" class="btn btn-theme" style="display:inline">변경</button>
                                                                            </cetner>
                                                                            <input type="hidden" name="wholenumber" value=<%=item.wholenumber%>>
                                                                        </form>



                                                                    </div>
                                                                    <div class="modal-footer">

                                                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">


                                                        <%= item.status %>


                                                    </td>

                                                    <td class="text-center">

                                                        <form action="/selldetail" method="post">

                                                            <input type="hidden" name="wholenumber" value=<%=item.wholenumber%>>
                                                            <input type="hidden" name="dealnumber" value=<%=item.dealnumber%>>
                                                            <button type="submit" class="btn btn-theme">이동</button>

                                                        </form>



                                                    </td>

                                                </tr>



                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>

                                </article>

                            </div>
                        </div>
                        <div class="tab-pane fade in" id="tab3">
                            <div class="col-lg-12">
                                <article>
                                    <div class="post-image">
                                        <div class="post-heading">
                                            <h3>회원님께서 구매하는 차량입니다.</h3>
                                        </div>
                                        <hr>
                                        <table class="table table-bordered table-hover slideanim" id="buylist">
                                            <thead>
                                                <tr>
                                                    <th text-align="center" class="text-center">번호</th>
                                                    <th text-align="center" class="text-center">거래번호</th>
                                                    <th text-align="center" class="text-center">차대번호</th>
                                                    <th text-align="center" class="text-center">거래상태</th>
                                                    <th text-align="center" class="text-center">구매취소</th>
                                                    <th text-align="center" class="text-center">상세보기</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                                <% buy.forEach(function(item2, index){  %>
                                                <tr>
                                                    <td class="count text-center"></td>
                                                    <td class="text-center">
                                                        <%= item2.dealnumber%>
                                                    </td>
                                                    <td class="text-center">
                                                        <%= item2.wholenumber%>
                                                    </td>
                                                    <td class="text-center">
                                                        <%= item2.status %>

                                                    </td>
                                                    <td class="text-center">
                                                        <script>
                                                            function conf()
                                            {
                                                if (confirm("정말 취소하시겠습니까?")) {
                                                document.cancelform.submit(); 
                                            } else {
                                                // no click
                                            }
                                                
                                        }
                                </script>
                                                        <form action="/mypage/cancel" method="post" onSubmit="conf(); return false" name="cancelform">
                                                            <input type="hidden" name="wholenumber" value=<%=item2.wholenumber%>>
                                                            <button type="submit" class="btn btn-danger">취소</button>

                                                        </form>
                                                    </td>
                                                    <td class="text-center">

                                                        <form action="/buydetail" method="post">
                                                            <input type="hidden" name="wholenumber" value=<%=item2.wholenumber%>>
                                                            <input type="hidden" name="dealnumber" value=<%=item2.dealnumber%>>
                                                            <input type="hidden" name="accountaddr" value=<%=item2.contractaddr%>>
                                                            <button type="submit" class="btn btn-theme">이동</button>
                                                        </form>

                                                    </td>



                                                </tr>


                                                <% }) %>

                                            </tbody>
                                        </table>
                                    </div>

                                </article>

                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </section>
        <footer>
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="widget">
                            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
                        </div>
                    </div>


                </div>
            </div>

        </footer>
    </div>
    <a href="#" class="scrollup"><i class="fa fa-angle-up active"></i></a>
    <!-- javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="javascripts/jquery.js"></script>
    <script src="javascripts/jquery.easing.1.3.js"></script>
    <script src="javascripts/bootstrap.min.js"></script>
    <script src="javascripts/jquery.fancybox.pack.js"></script>
    <script src="javascripts/jquery.fancybox-media.js"></script>
    <script src="javascripts/google-code-prettify/prettify.js"></script>
    <script src="javascripts/portfolio/jquery.quicksand.js"></script>
    <script src="javascripts/portfolio/setting.js"></script>
    <script src="javascripts/jquery.flexslider.js"></script>
    <script src="javascripts/animate.js"></script>
    <script src="javascripts/custom.js"></script>
    <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js'></script>
    <script src="https://cdn.jsdelivr.net/gh/icon-project/icon-sdk-js/build/icon-sdk-js.min.js"></script>
    <script src="javascripts/utf8.js"></script>
    <script>
        var iconService = window['icon-sdk-js'];
        var IconAmount = iconService.IconAmount;
        var IconConverter = iconService.IconConverter;
        var IconBuilder = iconService.IconBuilder;

        var contractAddress = document.getElementById("contractAddress");
        var enrollcar_enroll = document.getElementById("enrollcar_enroll");


        window.addEventListener("ICONEX_RELAY_RESPONSE", eventHandler, false);
        // type and payload are in event.detail
        function eventHandler(event) {
            var type = event.detail.type;
            var payload = event.detail.payload;
            switch (type) {
                case "RESPONSE_HAS_ACCOUNT":

                    break;


                case "RESPONSE_ADDRESS":
                    fromAddress = payload;
                    isRegist.innerHTML = "HELLO"
                    contractAddress.innerHTML = payload;
                    break;

                case "RESPONSE_JSON-RPC":
                    console.log(payload);
                    var HexToDecimal = parseInt(payload.result.toString(10), 16);
                    document.getElementById("TCTNum").innerHTML = HexToDecimal;
                    document.getElementById("TCTNum2").innerHTML = HexToDecimal;
                    break;
                case "CANCEL_JSON-RPC":
                    break;


                case "REQUEST_HAS_ICON":
                console.log(payload.result);

                    break;



                default:
            }

        }
        // Register onclick event to the button and dispatch a new CustomEvent ICONEX_RELAY_REQUEST



        function balanceOf() {
            var callBuilder = new IconBuilder.CallBuilder;
            var readOnlyData = callBuilder
                .from("<%=contractaddr%>")
                .to('cx905fdabf67bcf7b6de9bc164fab92840dc00aa3e')
                .method("balanceOf")
                .params({
                    "owner": "<%=contractaddr%>" 
                })
                .build();
            scoredata1 = JSON.stringify({
                "jsonrpc": "2.0",
                "method": "icx_call",
                "params": readOnlyData,
                "id": 50889
            });
            var parsed = JSON.parse(scoredata1);
            window.dispatchEvent(new CustomEvent('ICONEX_RELAY_REQUEST', {
                detail: {
                    type: 'RESPONSE_JSON-RPC',
                    payload: parsed
                }
            }));
        }

        function approve() {
            var callTransactionBuilder = new IconBuilder.CallTransactionBuilder;
            var callTransactionData = callTransactionBuilder
                .from("<%=contractaddr%>")
                .to("cx905fdabf67bcf7b6de9bc164fab92840dc00aa3e")
                .nid(IconConverter.toBigNumber(3))
                .timestamp((new Date()).getTime() * 1000)
                .stepLimit(IconConverter.toBigNumber(100000000))
                .version(IconConverter.toBigNumber(3))
                .method('approve')
                .params({
                    "spender": "cx7060d4aed45cd66993f75edb2f6c93d404dd239b",
                    "value": document.getElementById("Coin_Approve").value
                })
                .build();

            scoredata = JSON.stringify({
                "jsonrpc": "2.0",
                "method": "icx_sendTransaction",
                "params": IconConverter.toRawTransaction(callTransactionData),
                "id": 50889
            });
            var parsed = JSON.parse(scoredata);
            console.log(parsed);

            window.dispatchEvent(new CustomEvent('ICONEX_RELAY_REQUEST', {
                detail: {
                    type: 'REQUEST_JSON-RPC',
                    payload: parsed
                }
            }));
        }

        function transfer() {
            var callTransactionBuilder = new IconBuilder.CallTransactionBuilder;
            var callTransactionData = callTransactionBuilder
                .from("<%=contractaddr%>")
                .to("cx905fdabf67bcf7b6de9bc164fab92840dc00aa3e")
                .nid(IconConverter.toBigNumber(3))
                .timestamp((new Date()).getTime() * 1000)
                .stepLimit(IconConverter.toBigNumber(100000000))
                .version(IconConverter.toBigNumber(3))
                .method('transfer')
                .params({
                    "toAddr": document.getElementById("withdraw_Address").value,
                    "value" : document.getElementById("withdraw_value").value
                })
                .build();

            scoredata = JSON.stringify({
                "jsonrpc": "2.0",
                "method": "icx_sendTransaction",
                "params": IconConverter.toRawTransaction(callTransactionData),
                "id": 50889
            });
            var parsed = JSON.parse(scoredata);
            console.log(parsed);

            window.dispatchEvent(new CustomEvent('ICONEX_RELAY_REQUEST', {
                detail: {
                    type: 'REQUEST_JSON-RPC',
                    payload: parsed
                }
            }));
        }


        function setCar() {
            var callTransactionBuilder = new IconBuilder.CallTransactionBuilder;
            var callTransactionData = callTransactionBuilder
                .from("<%=contractaddr%>")
                .to("cx1bb212f4567f43ddac4cf24a9ed99f71e9ca36a5")
                .nid(IconConverter.toBigNumber(3))
                .timestamp((new Date()).getTime() * 1000)
                .stepLimit(IconConverter.toBigNumber(100000000))
                .version(IconConverter.toBigNumber(3))
                .method('setCar')
                .params({
                    "_carNumber": document.getElementById("car_registed_string").value
                })
                .build();

            scoredata = JSON.stringify({
                "jsonrpc": "2.0",
                "method": "icx_sendTransaction",
                "params": IconConverter.toRawTransaction(callTransactionData),
                "id": 50889
            });
            var parsed = JSON.parse(scoredata);
            console.log(parsed);

            window.dispatchEvent(new CustomEvent('ICONEX_RELAY_REQUEST', {
                detail: {
                    type: 'REQUEST_JSON-RPC',
                    payload: parsed
                }
            }));
        }

        function balanceOf() {
            var callBuilder = new IconBuilder.CallBuilder;
            var readOnlyData = callBuilder
                .from("<%=contractaddr%>")
                .to('cx905fdabf67bcf7b6de9bc164fab92840dc00aa3e')
                .method("balanceOf")
                .params({
                    "owner": "<%=contractaddr%>" //car number
                })
                .build();
            scoredata1 = JSON.stringify({
                "jsonrpc": "2.0",
                "method": "icx_call",
                "params": readOnlyData,
                "id": 50889
            });
            var parsed = JSON.parse(scoredata1);
            console.log(parsed);
            window.dispatchEvent(new CustomEvent('ICONEX_RELAY_REQUEST', {
                detail: {
                    type: 'REQUEST_JSON-RPC',
                    payload: parsed
                }
            }));
        }

        window.onload = function() {
            balanceOf();
        }



    </script>
</body>

</html>
